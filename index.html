<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Liga de Baloncesto Persistente</title>
<style>
body{margin:0;font-family:system-ui;background:#0e1320;color:#fff;}
header{background:#141a33;padding:10px 20px;position:sticky;top:0;z-index:5}
main{display:grid;gap:12px;padding:20px;grid-template-columns:1fr 1fr;}
@media(max-width:900px){main{grid-template-columns:1fr;}}
.card{background:#1c2444;border-radius:10px;padding:15px;border:1px solid #2a335a;}
button{cursor:pointer;border-radius:6px;padding:8px 12px;border:1px solid #2a335a;font-weight:600;}
button.primary{background:#4da3ff;color:#021023;}
button.ok{background:#2ecc71;color:#021015;}
button.bad{background:#ff5c5c;color:#230000;}
textarea{width:100%;height:130px;background:#0f152b;color:#fff;border:1px solid #2a335a;border-radius:8px;padding:8px;}
.pill{display:inline-block;background:#232b55;border:1px solid #2a335a;border-radius:999px;padding:4px 10px;margin:2px;font-size:13px;}
.team{background:#212845;padding:10px;border-radius:8px;margin-bottom:10px;}
.chip{display:inline-block;background:#28335e;padding:5px 8px;border-radius:8px;margin:2px;}
</style>
</head>
<body>
<header><h2>üèÄ Liga de Baloncesto Persistente</h2></header>
<main>
<section class="card">
<h3>Cargar jugadores</h3>
<textarea id="seed" placeholder="Ejemplo:
1. Max Diclo
2. Juan (invitado)
3. Pedro"></textarea>
<button class="primary" id="load">Cargar</button>
<hr>
<h4>Liga</h4><div id="liga" class="queue"></div>
<h4>Invitados</h4><div id="invitados" class="queue"></div>
</section>
<section class="card">
<h3>Partido</h3>
<div id="estado"></div>
<div class="team"><h4>Equipo A</h4><div id="A"></div></div>
<div class="team"><h4>Equipo B</h4><div id="B"></div></div>
<button class="ok" id="ganaA">Gana Equipo A</button>
<button class="bad" id="ganaB">Gana Equipo B</button>
<button class="primary" id="siguiente">‚û°Ô∏è Siguiente Partido</button>
</section>
</main>

<script>
let liga=[],invitados=[],colaLiga=[],colaInvitados=[],campeon=[],racha=0,standby=[],A=[],B=[],ultimoEnCancha=new Set(),modo='idle',nPartido=0;

function $(x){return document.querySelector(x);}

function render(){
 $("#liga").innerHTML=colaLiga.map(n=>`<span class='pill'>${n}</span>`).join('');
 $("#invitados").innerHTML=colaInvitados.map(n=>`<span class='pill'>${n}</span>`).join('');
 $("#A").innerHTML=A.map(n=>`<span class='pill'>${n}</span>`).join('');
 $("#B").innerHTML=B.map(n=>`<span class='pill'>${n}</span>`).join('');
 $("#estado").innerHTML=`<div class='chip'>Partido: ${nPartido}</div> 
 <div class='chip'>Racha: ${racha}</div> 
 <div class='chip'>Modo: ${modo}</div> 
 <div class='chip'>Campe√≥n: ${campeon.join(', ')||'‚Äî'}</div> 
 <div class='chip'>Standby: ${standby.join(', ')||'‚Äî'}</div>`;
}

// Parsear lista de texto
function parseLista(txt){
 const l=txt.split('\n').map(s=>s.replace(/^\d+\W*/,'').trim()).filter(Boolean);
 const L=[],I=[];
 for(const n of l){/\(invitado\)/i.test(n)?I.push(n.replace(/\(invitado\)/i,'').trim()):L.push(n);}
 return {L,I};
}

// Tomar n jugadores de la cola sin repetir los que est√°n en ex
function tomar(cola,n,ex=new Set()){
 const seleccion=[];
 let i=0;
 while(seleccion.length<n && i<cola.length*2){
   const jugador=cola.shift();
   if(!ex.has(jugador)) seleccion.push(jugador);
   cola.push(jugador);
   i++;
 }
 return seleccion;
}

// Primer partido: 10 jugadores de liga
function partida1(){
 const seleccion=tomar(colaLiga,10);
 const shuffled=seleccion.sort(()=>Math.random()-0.5);
 A=shuffled.slice(0,5);
 B=shuffled.slice(5);
 modo='normal'; nPartido=1;
 ultimoEnCancha=new Set([...A,...B]);
}

// Retador normal: 3 liga + 2 invitados
function retador(){
 let ex=new Set([...ultimoEnCancha, ...campeon]);
 let L=tomar(colaLiga,3,ex);
 let I=tomar(colaInvitados,2,ex);
 if(I.length<2)L=L.concat(tomar(colaLiga,2-I.length,ex));
 return L.concat(I);
}

// Partido cuando el campe√≥n juega contra retador normal
function partidoNormal(){
 A=campeon.slice();
 B=retador();
 modo='normal'; nPartido++; 
 ultimoEnCancha=new Set([...A,...B]);
}

// Partido con 10 nuevos cuando el equipo ganador se sienta (standby)
function partido10nuevos(){
 let ex=new Set([...ultimoEnCancha, ...campeon]);
 let nuevosA=tomar(colaLiga,3,ex).concat(tomar(colaInvitados,2,ex));
 let nuevosB=tomar(colaLiga,3,ex).concat(tomar(colaInvitados,2,ex));
 A=nuevosA;
 B=nuevosB;
 modo='standby';
 nPartido++;
 ultimoEnCancha=new Set([...A,...B]);
}

// Siguiente partido
function siguiente(){
 if(nPartido===0){ partida1(); render(); return; }

 // Si hay equipo en standby y no estamos en modo standby: enfrentamiento campe√≥n vs ganador de 10 nuevos
 if(standby.length && modo!=='standby'){
   A=standby.slice();
   B=retador();
   standby=[];
   modo='normal';
   nPartido++;
   ultimoEnCancha=new Set([...A,...B]);
   render(); 
   return;
 }

 // Si hay campe√≥n y gan√≥ 2 veces consecutivas: sentar y entrar 10 nuevos
 if(campeon.length===5 && racha>=2){
   standby=campeon.slice();
   campeon=[];
   racha=0;
   partido10nuevos();
   render();
   return;
 }

 if(modo==='standby'){ // ganador de 10 nuevos enfrentando al standby
   partidoNormal();
   render();
   return;
 }

 // Partido normal entre campe√≥n y retador
 if(campeon.length===5){
   partidoNormal();
   render();
   return;
 }

 render();
}

// Marcar ganador
function gana(quien){
 if(modo==='idle') return;
 let AA=A.slice(), BB=B.slice();

 if(modo==='standby'){
   // Ganador del partido 10 nuevos
   const win=(quien==='A'?AA:BB);
   const lose=(quien==='A'?BB:AA);
   campeon=win.slice();
   racha=1;
   modo='normal';
   // Los perdedores van al final de sus colas
   for(const j of lose){
     if(invitados.includes(j)) colaInvitados.push(j);
     else colaLiga.push(j);
   }
 } else {
   // Partido normal
   if(campeon.length===0){ // primer partido normal
     campeon=(quien==='A'?AA:BB);
     racha=1;
     const lose=(quien==='A'?BB:AA);
     for(const j of lose){
       if(invitados.includes(j)) colaInvitados.push(j);
       else colaLiga.push(j);
     }
   } else {
     const win=(quien==='A'?AA:BB);
     const lose=(quien==='A'?BB:AA);
     if(win.join()===campeon.join()){
       racha++;
     } else {
       campeon=win.slice();
       racha=1;
     }
     for(const j of lose){
       if(invitados.includes(j)) colaInvitados.push(j);
       else colaLiga.push(j);
     }
   }
 }
 modo='idle';
 render();
}

// Cargar lista
$("#load").onclick=()=>{
 const {L,I}=parseLista($("#seed").value);
 liga=L; invitados=I;
 colaLiga=[...L]; colaInvitados=[...I];
 campeon=[]; racha=0; standby=[]; A=[]; B=[]; ultimoEnCancha=new Set(); nPartido=0; modo='idle';
 render();
}

$("#siguiente").onclick=()=>{siguiente();}
$("#ganaA").onclick=()=>{gana('A');}
$("#ganaB").onclick=()=>{gana('B');}

render();
</script>
</body>
</html>
